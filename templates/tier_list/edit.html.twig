{% extends 'base.html.twig' %}

{% block title %}Edit {{ category }} Tier List{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    body {
        background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 31, 58, 0.95) 100%);
        min-height: 100vh;
        padding: 120px 20px 40px;
    }
    .manage-container { max-width: 1600px; margin: 0 auto; }
    .manage-header { 
        display: flex; 
        flex-direction: column;
        gap: 15px;
        margin-bottom: 25px;
        background: rgba(255,255,255,0.05);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid rgba(0,255,136,0.3);
    }
    .manage-title { 
        color: #00ff88; 
        font-size: 2rem; 
        font-weight: 900; 
        margin: 0;
        text-align: center;
    }
    .header-actions { 
        display: flex; 
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .btn-action { 
        padding: 12px 24px; 
        border-radius: 10px; 
        text-decoration: none; 
        font-weight: 700; 
        font-size: 1rem; 
        transition: all 0.3s ease; 
        border: none; 
        cursor: pointer; 
        display: inline-block;
    }
    .btn-view { 
        background: rgba(255,255,255,0.15); 
        color: #fff; 
        border: 2px solid rgba(255,255,255,0.4); 
    }
    .btn-view:hover { 
        background: rgba(255,255,255,0.25); 
        transform: scale(1.05);
    }
    .btn-save { 
        background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%); 
        color: #0a0e27; 
        font-weight: 900;
        box-shadow: 0 4px 15px rgba(0,255,136,0.4);
    }
    .btn-save:hover { 
        transform: translateY(-3px) scale(1.05); 
        box-shadow: 0 10px 30px rgba(0,255,136,0.6); 
    }
    .btn-delete { 
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
        color: #fff; 
        border: none;
        font-weight: 900;
        box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .btn-delete:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 30px rgba(239,68,68,0.6);
    }
    
    .category-selector { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .category-selector label { color: #00ff88; font-weight: 700; }
    .category-selector select { padding: 8px 12px; background: rgba(10,14,39,0.8); border: 2px solid rgba(0,255,136,0.4); border-radius: 8px; color: #fff; font-weight: 600; }
    
    .tier-section { background: rgba(255,255,255,0.03); border: 2px solid; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
    .tier-section h3 { margin: 0 0 15px 0; font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; gap: 10px; }
    
    .hero-select-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap; }
    .hero-select-row select { flex: 1; min-width: 200px; padding: 10px; background: rgba(10,14,39,0.95); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-weight: 600; font-size: 0.95rem; }
    .hero-select-row select option { background: #0a0e27; color: #fff; padding: 8px; }
    .hero-select-row select:focus { border-color: #00ff88; outline: none; }
    .hero-select-row .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; padding: 10px 20px; border-radius: 8px; font-weight: 700; }
    .hero-select-row .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16,185,129,0.4); }
    
    .heroes-grid { display: flex; gap: 10px; flex-wrap: wrap; min-height: 80px; }
    .hero-card { position: relative; width: 70px; height: 90px; border-radius: 8px; overflow: hidden; border: 2px solid; transition: all 0.3s ease; }
    .hero-card img { width: 100%; height: 100%; object-fit: cover; }
    .hero-card .hero-name { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.95)); color: #fff; padding: 4px; text-align: center; font-size: 0.6rem; font-weight: 700; }
    .hero-card .remove-btn { position: absolute; top: 4px; right: 4px; background: rgba(239,68,68,0.95); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 10; }
    .hero-card:hover .remove-btn { opacity: 1; }
    .hero-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,255,136,0.3); }
    
    .hero-card.rarity-legendary, .hero-card.rarity-l√©gendaire { border-color: #ffd700; box-shadow: 0 2px 8px rgba(255,215,0,0.3); }
    .hero-card.rarity-epic { border-color: #a855f7; box-shadow: 0 2px 8px rgba(168,85,247,0.3); }
    .hero-card.rarity-rare { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
    .hero-card.rarity-uncommon { border-color: #10b981; box-shadow: 0 2px 8px rgba(16,185,129,0.3); }
    .hero-card.rarity-common { border-color: #9ca3af; box-shadow: 0 2px 8px rgba(156,163,175,0.3); }
    
    .tier-S { border-color: #ff1744; }
    .tier-S h3 { color: #ff1744; }
    .tier-A { border-color: #ff9100; }
    .tier-A h3 { color: #ff9100; }
    .tier-B { border-color: #ffd600; }
    .tier-B h3 { color: #ffd600; }
    .tier-C { border-color: #00e676; }
    .tier-C h3 { color: #00e676; }
    .tier-D { border-color: #2979ff; }
    .tier-D h3 { color: #2979ff; }
    .tier-F { border-color: #9e9e9e; }
    .tier-F h3 { color: #9e9e9e; }
    
    @media (max-width: 768px) {
        .hero-card { width: 60px; height: 75px; }
        .manage-title { font-size: 1.4rem; }
    }
</style>
{% endblock %}

{% block body %}
<div class="manage-container">
    <div class="manage-header">
        <h1 class="manage-title">‚öôÔ∏è Edit {{ category }}</h1>
    </div>

    <div class="category-selector">
        <label>Category:</label>
        <select id="category-select" onchange="window.location.href='{{ path('app_tier_list_edit', {category:'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', this.value)">
            {% for cat in allCategories %}
                <option value="{{ cat }}" {{ cat == category ? 'selected' : '' }}>{{ cat }}</option>
            {% endfor %}
        </select>
        <button onclick="window.location.href='{{ path('app_tier_list_new') }}'" class="btn-action btn-save">‚ûï New</button>
        
        <div style="flex: 1;"></div>
        
        <a href="{{ path('app_tier_list_show', {category: category}) }}" class="btn-action btn-view">
            üëÅÔ∏è View
        </a>
        <button type="button" id="save-btn" class="btn-action btn-save">
            üíæ SAVE
        </button>
        <button type="button" id="delete-btn" class="btn-action btn-delete" onclick="if(confirm('Delete this tier list?')) document.getElementById('delete-form').submit();">
            üóëÔ∏è DELETE
        </button>
        <form id="delete-form" method="post" action="{{ path('app_tier_list_delete', {category: category}) }}" style="display:none;">
            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ category) }}">
        </form>
    </div>

    {% for tier in ['S','A','B','C','D','F'] %}
    <div class="tier-section tier-{{ tier }}">
        <h3>{{ tier }} Tier</h3>
        
        <div class="hero-select-row">
            <select id="select-{{ tier }}" class="hero-selector">
                <option value="">-- Select a hero --</option>
                {% for hero in unrankedHeroes %}
                    <option value="{{ hero.id }}" 
                            data-name="{{ hero.name }}" 
                            data-image="{{ hero.imageUrl }}" 
                            data-rarity="{% if hero.rarityEntity %}{{ hero.rarityEntity.name|lower }}{% endif %}">
                        {% if hero.rarityEntity %}[{{ hero.rarityEntity.name }}]{% endif %} {{ hero.name }}
                    </option>
                {% endfor %}
            </select>
            <button type="button" class="btn-success" onclick="addHeroToTier('{{ tier }}')">
                <i class="fas fa-plus"></i> Add to {{ tier }}
            </button>
        </div>
        
        <div class="heroes-grid" id="grid-{{ tier }}" data-tier="{{ tier }}">
            {% for entry in tierData[tier] %}
                <div class="hero-card {% if entry.hero.rarityEntity %}rarity-{{ entry.hero.rarityEntity.name|lower }}{% endif %}" data-hero-id="{{ entry.hero.id }}" data-entry-id="{{ entry.id }}">
                    <img src="{{ entry.hero.imageUrl }}" alt="{{ entry.hero.name }}">
                    <div class="hero-name">{{ entry.hero.name }}</div>
                    <button class="remove-btn" onclick="removeHero(this, '{{ tier }}')">‚úï</button>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
const category = '{{ category }}';

function addHeroToTier(tier) {
    const select = document.getElementById(`select-${tier}`);
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption.value) {
        alert('Please select a hero first!');
        return;
    }
    
    const heroId = selectedOption.value;
    const heroName = selectedOption.dataset.name;
    const heroImage = selectedOption.dataset.image;
    const heroRarity = selectedOption.dataset.rarity;
    
    // V√©rifier si le h√©ros est d√©j√† dans un tier
    const existingCard = document.querySelector(`[data-hero-id="${heroId}"]`);
    if (existingCard) {
        alert('This hero is already in a tier!');
        return;
    }
    
    const grid = document.getElementById(`grid-${tier}`);
    
    const card = document.createElement('div');
    card.className = `hero-card ${heroRarity ? 'rarity-' + heroRarity : ''}`;
    card.dataset.heroId = heroId;
    card.dataset.entryId = '';
    
    card.innerHTML = `
        <img src="${heroImage}" alt="${heroName}">
        <div class="hero-name">${heroName}</div>
        <button class="remove-btn" onclick="removeHero(this, '${tier}')">‚úï</button>
    `;
    
    grid.appendChild(card);
    
    // RETIRER DE TOUS LES SELECTS (pas juste celui-ci)
    document.querySelectorAll('.hero-selector').forEach(s => {
        const opt = s.querySelector(`option[value="${heroId}"]`);
        if (opt) opt.remove();
    });
}

function removeHero(button, tier) {
    if (!confirm('Remove this hero?')) return;
    
    const card = button.closest('.hero-card');
    const heroId = card.dataset.heroId;
    const heroName = card.querySelector('.hero-name').textContent;
    const heroImage = card.querySelector('img').src;
    
    // R√©cup√©rer la raret√© depuis les classes
    let heroRarity = '';
    let rarityLabel = '';
    if (card.classList.contains('rarity-legendary') || card.classList.contains('rarity-l√©gendaire')) {
        heroRarity = 'legendary';
        rarityLabel = '[Legendary]';
    } else if (card.classList.contains('rarity-epic')) {
        heroRarity = 'epic';
        rarityLabel = '[Epic]';
    } else if (card.classList.contains('rarity-rare')) {
        heroRarity = 'rare';
        rarityLabel = '[Rare]';
    } else if (card.classList.contains('rarity-uncommon')) {
        heroRarity = 'uncommon';
        rarityLabel = '[Uncommon]';
    } else if (card.classList.contains('rarity-common')) {
        heroRarity = 'common';
        rarityLabel = '[Common]';
    }
    
    // Remettre dans TOUS les selects
    document.querySelectorAll('.hero-selector').forEach(select => {
        const option = document.createElement('option');
        option.value = heroId;
        option.dataset.name = heroName;
        option.dataset.image = heroImage;
        option.dataset.rarity = heroRarity;
        option.textContent = `${rarityLabel} ${heroName}`;
        select.appendChild(option);
    });
    
    card.remove();
}

document.getElementById('save-btn').addEventListener('click', async function() {
    const saveBtn = this;
    saveBtn.disabled = true;
    saveBtn.textContent = '‚è≥ Saving...';
    
    const updates = [];
    
    ['S','A','B','C','D','F'].forEach(tier => {
        const grid = document.getElementById(`grid-${tier}`);
        const cards = Array.from(grid.querySelectorAll('.hero-card'));
        
        cards.forEach((card, index) => {
            updates.push({
                id: card.dataset.entryId || null,
                heroId: card.dataset.heroId,
                tier: tier,
                order: index,
                category: category
            });
        });
    });
    
    try {
        for (const update of updates) {
            if (!update.id) {
                const response = await fetch('{{ path('app_tier_list_api_add') }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        heroId: update.heroId,
                        tier: update.tier,
                        category: category
                    })
                });
                const data = await response.json();
                if (data.entryId) {
                    update.id = data.entryId;
                    const card = document.querySelector(`[data-hero-id="${update.heroId}"]`);
                    if (card) card.dataset.entryId = data.entryId;
                }
            }
        }
        
        const existingUpdates = updates.filter(u => u.id);
        if (existingUpdates.length > 0) {
            await fetch('{{ path('app_tier_list_api_update_order') }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(existingUpdates)
            });
        }
        
        alert('‚úÖ Tier list saved successfully!');
        location.reload();
    } catch (error) {
        console.error('Save error:', error);
        alert('‚ùå Save failed. Check console.');
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save';
    }
});
</script>
{% endblock %}